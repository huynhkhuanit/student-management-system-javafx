package controller;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ResourceBundle;
import javax.security.auth.Subject;

import components.AlertComponent;
import javafx.fxml.FXML;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.chart.AreaChart;
import javafx.scene.chart.BarChart;
import javafx.scene.chart.LineChart;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.HBox;
import javafx.stage.Stage;
import util.showStage;
import javafx.scene.layout.StackPane;
import javafx.scene.control.TableView;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.control.cell.TextFieldTableCell;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn.CellEditEvent;
import javafx.stage.StageStyle;
import java.sql.Statement;
import java.util.Date;
import java.time.LocalDate;

// model data
import model.StudentData;
import model.CourseData;
import model.LecturerData;
import database.database;
import controller.studentController;

public class dashboardController {
    // Database tools
    private Connection connect;
    private PreparedStatement preparedStatement;
    private Statement statement;
    private ResultSet resultSet;

    @FXML
    private Button closeBtn;

    @FXML
    private Button dashboardBtn;

    @FXML
    private AnchorPane dashboardForm;

    @FXML
    private StackPane mainDashboard;

    @FXML
    private Button minimizeBtn, logoutBtn;

    @FXML
    private ResourceBundle resources;

    // ========== DASHBOARD PROPERTY ==========

    @FXML
    private Label totalStudentsLabel, totalMaleStudentsLabel, totalFemaleStudentsLabel;
    @FXML
    private AreaChart<?, ?> avgScoreChart;
    @FXML
    private LineChart<?, ?> yearlyStatsChart;
    @FXML
    private BarChart<?, ?> totalStudentsChart;

    // ========== DASHBOARD PROPERTY ==========

    // ========== SINH VI√äN PROPERTY ==========
    @FXML
    private AnchorPane studentManageForm;
    @FXML
    private Button studentManageBtn;

    // B·∫£ng d·ªØ li·ªáu sinh vi√™n
    @FXML
    private TableView<StudentData> studentTable;

    // C√°c c·ªôt trong b·∫£ng sinh vi√™n
    @FXML
    private TableColumn<StudentData, String> student_colStudentID; // C·ªôt MSSV
    @FXML
    private TableColumn<StudentData, String> student_colLastName; // C·ªôt T√™n
    @FXML
    private TableColumn<StudentData, String> student_colFirstName; // C·ªôt H·ªç
    @FXML
    private TableColumn<StudentData, String> student_colBirthYear; // C·ªôt NƒÉm sinh
    @FXML
    private TableColumn<StudentData, String> student_colGender; // C·ªôt Gi·ªõi t√≠nh
    @FXML
    private TableColumn<StudentData, String> student_colSchoolYear; // C·ªôt NƒÉm h·ªçc
    @FXML
    private TableColumn<StudentData, String> student_colMajor; // C·ªôt Chuy√™n ng√†nh
    @FXML
    private TableColumn<StudentData, String> student_colSubject; // C·ªôt M√¥n h·ªçc
    @FXML
    private TableColumn<StudentData, String> student_colStatus; // C·ªôt Tr·∫°ng th√°i

    // üîò Khu v·ª±c ch·ª©a c√°c n√∫t ƒëi·ªÅu khi·ªÉn
    @FXML
    private HBox controlButtonsBox;

    @FXML
    private Button btnAdd;

    @FXML
    private Button btnClearAll;

    @FXML
    private Button btnDelete;

    @FXML
    private Button btnRefresh;

    @FXML
    private Button btnUpdate;

    // √î t√¨m ki·∫øm
    @FXML
    private TextField studentManageSearch;

    // ========== SINH VI√äN PROPERTY ==========

    // ========== M√îN H·ªåC PROPERTY ==========

    @FXML
    private Button courseManageBtn;
    @FXML
    private AnchorPane courseManageForm;
    @FXML
    private TextField txtSubjectID, txtSubjectName, txtCredits;
    @FXML
    private ComboBox<String> cbSemester, cbStatus, cbLecturer;
    @FXML
    private TableView<CourseData> tblSubjects;
    @FXML
    private TableColumn<CourseData, String> colSubjectID, colSubjectName, colLecturer, colSemester, colStatus;
    @FXML
    private TableColumn<CourseData, Integer> colCredits;
    @FXML
    private Button btnAddSubject, btnDeleteSubject, btnClearAllSubjects, btnUpdateSubject,
            btnClearFormSubject;

    // ========== M√îN H·ªåC PROPERTY ==========

    // =========== QU·∫¢N L√ù GI·∫¢NG VI√äN ===========
    @FXML
    private Button lecturerManageBtn;
    @FXML
    private AnchorPane lecturerManageForm;
    @FXML
    private TextField txtLecturerID, txtLecturerName, txtLecturerPhone;
    @FXML
    private ComboBox<String> cbLecturerGender, cbLecturerDegree, cbLecturerStatus;
    @FXML
    private TableView<LecturerData> tableLecturer;
    @FXML
    private TableColumn<LecturerData, String> colLecturerID, colLecturerName, colLecturerGender, colLecturerDegree,
            colLecturerPhone,
            colLecturerStatus;
    @FXML
    private Button btnAddLecturer, btnDeleteLecturer, btnClearAllLecturer, btnUpdateLecturer,
            btnClearFormLecturer;

    // - C·∫ßn t·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Lecturer
    // private ObservableList<Lecturer> lecturerList =
    // FXCollections.observableArrayList();

    // =========== QU·∫¢N L√ù GI·∫¢NG VI√äN ===========

    // =========== QU·∫¢N L√ù ƒêI·ªÇM ===========

    @FXML
    private AnchorPane gradesManageForm;
    @FXML
    private TextField txtStudentIDGrades, txtMidtermGrade, txtFinalGrade, txtTotalGrade, txtSearchGrades;

    @FXML
    private Label lblSchoolYearGrades, lblSubjectGrades;

    @FXML
    private Button btnAddGrades, btnRefreshGrades, btnDeleteGrades, btnClearAllGrades, btnUpdateGrades,
            btnClearFormGrades, gradesManageBtn;

    @FXML
    private TableView<?> tableGrades;

    @FXML
    private TableColumn<?, ?> colStudentIDGrades, colSchoolYearGrades, colSubjectGrades, colMidtermGrade,
            colFinalGrade, colTotalGrade;

    // =========== QU·∫¢N L√ù ƒêI·ªÇM ===========

    // =========== TH√îNG TIN ===========

    @FXML
    private Button infoManageBtn, versionBtn, teamBtn, technologyBtn, clauseBtn, questionBtn;
    @FXML
    private AnchorPane infoManageForm, versionForm, teamForm, technologyForm, clauseForm, questionForm;

    // =========== TH√îNG TIN ===========

    // To·∫° ƒë·ªô x v√† y ƒë·ªÉ di chuy·ªÉn c·ª≠a s·ªï
    private double xOffset = 0;
    private double yOffset = 0;

    @FXML
    public void initialize() {
        // ========== Load d·ªØ li·ªáu t·ª´ database cho c√°c b·∫£ng ==========

        addStudentsShowList(); // Load d·ªØ li·ªáu sinh vi√™n
        showCoursesList(); // Load d·ªØ li·ªáu m√¥n h·ªçc
        showLecturersList(); // Load d·ªØ li·ªáu gi·∫£ng vi√™n

        updateLecturersInCourse(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong ComboBox

        // ========== Load d·ªØ li·ªáu t·ª´ database cho c√°c b·∫£ng ==========

        // ·∫®n c√°c form qu·∫£n l√Ω
        dashboardForm.setVisible(true);
        studentManageForm.setVisible(false);
        courseManageForm.setVisible(false);
        lecturerManageForm.setVisible(false);
        gradesManageForm.setVisible(false);
        infoManageForm.setVisible(false);

        // Drag window
        mainDashboard.setOnMousePressed(e -> {
            xOffset = e.getSceneX();
            yOffset = e.getSceneY();
        });

        mainDashboard.setOnMouseDragged(e -> {
            Stage currentStage = (Stage) mainDashboard.getScene().getWindow();
            currentStage.setX(e.getScreenX() - xOffset);
            currentStage.setY(e.getScreenY() - yOffset);

            // Set opacity to 0.8 when dragging
            currentStage.setOpacity(0.8);
        });

        mainDashboard.setOnMouseReleased(e -> {
            Stage currentStage = (Stage) mainDashboard.getScene().getWindow();
            currentStage.setOpacity(1.0);
        });

        // Close windows
        closeBtn.setOnAction(e -> {
            System.exit(0);
        });

        // Minimize windows
        minimizeBtn.setOnAction(e -> {
            Stage currentStage = (Stage) minimizeBtn.getScene().getWindow();
            currentStage.setIconified(true);
        });

        // Logout
        logoutBtn.setOnAction(e -> logoutHandle());

        // ========== SHOW FORMS ==========
        dashboardBtn.setOnAction(e -> switchForm(dashboardForm, dashboardBtn));
        studentManageBtn.setOnMouseClicked(e -> switchForm(studentManageForm, studentManageBtn));
        courseManageBtn.setOnMouseClicked(e -> switchForm(courseManageForm, courseManageBtn));
        lecturerManageBtn.setOnMouseClicked(e -> switchForm(lecturerManageForm, lecturerManageBtn));
        gradesManageBtn.setOnMouseClicked(e -> switchForm(gradesManageForm, gradesManageBtn));
        infoManageBtn.setOnMouseClicked(e -> switchForm(infoManageForm, infoManageBtn));

        // ========== SHOW FORMS ==========

        // ========== QU·∫¢N L√ù SINH VI√äN ==========

        // S·ª± ki·ªán nh·∫•p ƒë√∫p chu·ªôt v√†o m·ªôt d√≤ng trong b·∫£ng sinh vi√™n -> M·ªü form ch·ªânh s·ª≠a
        studentTable.setOnMouseClicked(e -> {
            if (e.getClickCount() == 2) { // N·∫øu nh·∫•p ƒë√∫p chu·ªôt v√†o m·ªôt d√≤ng
                openStudentForm();
            }
        });
        btnAdd.setOnAction(e -> handleAddBtn()); // Ph∆∞∆°ng th·ª©c th√™m sinh vi√™n
        btnRefresh.setOnAction(e -> {
            studentManageSearch.clear(); // Xo√° n·ªôi dung √¥ t√¨m ki·∫øm khi l√†m m·ªõi
            addStudentsShowList();
        }); // Ph∆∞∆°ng th·ª©c l√†m m·ªõi b·∫£ng sinh vi√™n
        btnUpdate.setOnAction(e -> handleUpdateStudent()); // Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t sinh vi√™n
        btnDelete.setOnAction(e -> handleDeleteStudent()); // Ph∆∞∆°ng th·ª©c x√≥a sinh vi√™n
        btnClearAll.setOnAction(e -> handleDeleteAllStudents()); // Ph∆∞∆°ng th·ª©c x√≥a to√†n b·ªô sinh vi√™n
        studentManageSearch.textProperty().addListener((observable, oldValue, newValue) -> searchStudent());
        // T√¨m ki·∫øm sinh vi√™n

        // ========== QU·∫¢N L√ù SINH VI√äN ==========

        // ========== QU·∫¢N L√ù M√îN H·ªåC ==========

        cbSemester.getItems().addAll("Ch·ªçn", "H·ªçc k·ª≥ 1", "H·ªçc k·ª≥ 2", "H·ªçc k·ª≥ 3");
        cbStatus.getItems().addAll("Ch·ªçn", "ƒêang m·ªü", "ƒê√≥ng");

        tblSubjects.setOnMouseClicked(e -> {
            if (e.getClickCount() == 2) { // Ki·ªÉm tra n·∫øu nh·∫•p ƒë√∫p chu·ªôt
                loadSelectedCourseData();
                btnAddSubject.setDisable(true); // Kh√≥a n√∫t th√™m
            }
        });

        // Ph∆∞∆°ng th·ª©c th√™m m√¥n h·ªçc
        btnAddSubject.setOnAction(e -> handleAddCourse()); // Th√™m m√¥n h·ªçc
        btnDeleteSubject.setOnAction(e -> handleDeleteCourse()); // X√≥a m√¥n h·ªçc
        btnClearAllSubjects.setOnAction(e -> handleDeleteAllCourses()); // X√≥a to√†n b·ªô m√¥n h·ªçc
        btnUpdateSubject.setOnAction(e -> handleUpdateCourse()); // C·∫≠p nh·∫≠t m√¥n h·ªçc
        btnClearFormSubject.setOnAction(e -> clearFormSubject()); // Xo√° form nh·∫≠p li·ªáu

        // ========== QU·∫¢N L√ù M√îN H·ªåC ==========

        // ========== QU·∫¢N L√ù GI·∫¢NG VI√äN ==========
        tableLecturer.setOnMouseClicked(e -> {
            if (e.getClickCount() == 2) { // Ki·ªÉm tra n·∫øu nh·∫•p ƒë√∫p chu·ªôt
                loadSelectedLecturerData();
                btnAddLecturer.setDisable(true); // Kh√≥a n√∫t th√™m
            }
        });

        // Kh·ªüi t·∫°o d·ªØ li·ªáu cho ComboBox
        cbLecturerGender.getItems().addAll("Ch·ªçn", "Nam", "N·ªØ");
        cbLecturerDegree.getItems().addAll("Ch·ªçn", "C·ª≠ nh√¢n", "Th·∫°c sƒ©", "Ti·∫øn sƒ©", "Ph√≥ gi√°o s∆∞", "Gi√°o s∆∞");
        cbLecturerStatus.getItems().addAll("Ch·ªçn", "ƒêang gi·∫£ng d·∫°y", "Ngh·ªâ ph√©p", "ƒê√£ ngh·ªâ h∆∞u");

        // Th√™m s·ª± ki·ªán cho c√°c Button
        btnAddLecturer.setOnAction(e -> handleAddLecturer());
        btnUpdateLecturer.setOnAction(e -> handleUpdateLecturer());
        btnDeleteLecturer.setOnAction(e -> handleDeleteLecturer());
        btnClearFormLecturer.setOnAction(e -> handleClearFormLecturer());
        btnClearAllLecturer.setOnAction(e -> handleClearAllLecturer());

        // ========== QU·∫¢N L√ù GI·∫¢NG VI√äN ==========

        // ========== QU·∫¢N L√ù ƒêI·ªÇM ==========

        // G√°n d·ªØ li·ªáu m·∫∑c ƒë·ªãnh cho b·∫£ng ƒëi·ªÉm
        setupTableColumns();
        loadGradesData();

        // S·ª± ki·ªán n√∫t th√™m ƒëi·ªÉm
        btnAddGrades.setOnAction(e -> handleAddGrades());

        // S·ª± ki·ªán n√∫t c·∫≠p nh·∫≠t ƒëi·ªÉm
        btnUpdateGrades.setOnAction(e -> handleUpdateGrades());

        // S·ª± ki·ªán n√∫t x√≥a ƒëi·ªÉm
        btnDeleteGrades.setOnAction(e -> handleDeleteGrades());

        // S·ª± ki·ªán n√∫t x√≥a to√†n b·ªô ƒëi·ªÉm
        btnClearAllGrades.setOnAction(e -> handleClearAllGrades());

        // S·ª± ki·ªán n√∫t l√†m m·ªõi form
        btnRefreshGrades.setOnAction(e -> handleRefreshGrades());

        // S·ª± ki·ªán n√∫t x√≥a th√¥ng tin nh·∫≠p li·ªáu
        btnClearFormGrades.setOnAction(e -> clearGradesForm());

        // G√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh
        btnAddGrades.setDisable(true);

        // ========== QU·∫¢N L√ù ƒêI·ªÇM ==========

        // ========== TH√îNG TIN ==========

        versionBtn.setOnAction(e -> versionBtnHandle());
        teamBtn.setOnAction(e -> teamBtnHandle());
        technologyBtn.setOnAction(e -> technologyBtnHandle());
        clauseBtn.setOnAction(e -> clauseBtnHandle());
        questionBtn.setOnAction(e -> questionBtnHandle());

        // ========== TH√îNG TIN ==========
    }

    // ---> C√ÅC H√ÄM X·ª¨ L√ù <---

    // - Tong quan -

    // Phuong thuc hien thi form duoc chon va an cac form con lai
    private void switchForm(AnchorPane selectedForm, Button selectedButton) {
        // Danh s√°ch t·∫•t c·∫£ c√°c form
        AnchorPane[] allForms = { dashboardForm, studentManageForm, courseManageForm, lecturerManageForm,
                gradesManageForm, infoManageForm };

        // Danh s√°ch c√°c n√∫t t∆∞∆°ng ·ª©ng
        Button[] allButtons = { dashboardBtn, studentManageBtn, courseManageBtn, lecturerManageBtn, gradesManageBtn,
                infoManageBtn };

        // X·ª≠ l√Ω hi·ªÉn th·ªã form
        for (AnchorPane form : allForms) {
            form.setVisible(form == selectedForm);
        }

        // ƒê·∫∑t m√†u n·ªÅn cho n√∫t ƒë∆∞·ª£c ch·ªçn v√† reset c√°c n√∫t kh√°c
        for (Button button : allButtons) {
            if (button == selectedButton) {
                button.setStyle("-fx-background-color: #0093e9;");
            } else {
                button.setStyle("-fx-background-color: transparent;");
            }
        }
    }

    private void logoutHandle() {
        try {
            // Thong bao xac nhan dang xuat
            if (AlertComponent.showConfirmation("Th√¥ng b√°o x√°c nh·∫≠n", null, "B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
                logoutBtn.getScene().getWindow().hide();
                Parent root = FXMLLoader.load(getClass().getResource("../view/login.fxml"));
                Stage stage = new Stage();
                Scene scene = new Scene(root);

                // Drag window
                root.setOnMousePressed(e -> {
                    xOffset = e.getSceneX();
                    yOffset = e.getSceneY();
                });

                root.setOnMouseDragged(e -> {
                    Stage currentStage = (Stage) root.getScene().getWindow();
                    currentStage.setX(e.getScreenX() - xOffset);
                    currentStage.setY(e.getScreenY() - yOffset);

                    // Set opacity to 0.8 when dragging
                    currentStage.setOpacity(0.8);
                });

                root.setOnMouseReleased(e -> {
                    Stage currentStage = (Stage) root.getScene().getWindow();
                    currentStage.setOpacity(1.0);
                });

                stage.initStyle(StageStyle.TRANSPARENT);
                stage.setScene(scene);
                stage.show();
            } else
                return;

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // - Tong quan -

    // ========== QU·∫¢N L√ù SINH VI√äN ==========

    public ObservableList<StudentData> addStudentsListData() {
        ObservableList<StudentData> listStudents = FXCollections.observableArrayList();
        String sql = "SELECT * FROM students";
        connect = database.connectDB();

        try {
            StudentData studentData;
            preparedStatement = connect.prepareStatement(sql);
            resultSet = preparedStatement.executeQuery();

            while (resultSet.next()) {
                studentData = new StudentData(
                        resultSet.getString("student_id"),
                        resultSet.getString("first_name"),
                        resultSet.getString("last_name"),
                        resultSet.getDate("birth_date"),
                        resultSet.getString("gender"),
                        resultSet.getString("school_year"),
                        resultSet.getString("major"),
                        resultSet.getString("subject"),
                        resultSet.getString("status"),
                        resultSet.getString("photo_path"));

                listStudents.add(studentData);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return listStudents;
    }

    private ObservableList<StudentData> addStudentsListD;

    public void addStudentsShowList() {
        addStudentsListD = addStudentsListData();

        student_colStudentID.setCellValueFactory(new PropertyValueFactory<>("studentID"));
        student_colFirstName.setCellValueFactory(new PropertyValueFactory<>("firstName"));
        student_colLastName.setCellValueFactory(new PropertyValueFactory<>("lastName"));
        student_colBirthYear.setCellValueFactory(new PropertyValueFactory<>("birthDate"));
        student_colGender.setCellValueFactory(new PropertyValueFactory<>("gender"));
        student_colSchoolYear.setCellValueFactory(new PropertyValueFactory<>("schoolYear"));
        student_colMajor.setCellValueFactory(new PropertyValueFactory<>("major"));
        student_colSubject.setCellValueFactory(new PropertyValueFactory<>("subject"));
        student_colStatus.setCellValueFactory(new PropertyValueFactory<>("status"));

        studentTable.setItems(addStudentsListD);
    }

    private void openStudentForm() {
        // L·∫•y sinh vi√™n ƒë∆∞·ª£c ch·ªçn t·ª´ TableView
        StudentData selectedStudent = studentTable.getSelectionModel().getSelectedItem();

        if (selectedStudent == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt sinh vi√™n!");
            return;
        }

        try {
            // Load student_form.fxml
            FXMLLoader loader = new FXMLLoader(getClass().getResource("../view/student_form.fxml"));
            Parent root = loader.load();

            // L·∫•y controller c·ªßa student_form.fxml
            studentController controller = loader.getController();

            // G·ª≠i d·ªØ li·ªáu sinh vi√™n v√†o form
            controller.setStudentData(selectedStudent);

            // T·∫°o m·ªôt Stage m·ªõi ƒë·ªÉ hi·ªÉn th·ªã form
            Stage stage = new Stage();
            stage.initStyle(StageStyle.TRANSPARENT);
            stage.setScene(new Scene(root));
            stage.show();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void handleUpdateStudent() {
        StudentData selectedStudent = studentTable.getSelectionModel().getSelectedItem();

        if (selectedStudent == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt sinh vi√™n!");
            return;
        }

        try {
            // Load student_form.fxml
            FXMLLoader loader = new FXMLLoader(getClass().getResource("../view/student_form.fxml"));
            Parent root = loader.load();

            // L·∫•y controller c·ªßa student_form.fxml
            studentController controller = loader.getController();

            // G·ª≠i d·ªØ li·ªáu sinh vi√™n v√†o form nh∆∞ng cho ph√©p ch·ªânh s·ª≠a
            controller.setStudentData(selectedStudent);
            controller.enableEditMode(); // B·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a

            // T·∫°o m·ªôt Stage m·ªõi ƒë·ªÉ hi·ªÉn th·ªã form
            Stage stage = new Stage();
            stage.initStyle(StageStyle.TRANSPARENT);
            stage.setScene(new Scene(root));
            stage.show();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Ph∆∞∆°ng th·ª©c xo√° sinh vi√™n (1 sinh vi√™n)
    private void handleDeleteStudent() {
        StudentData selectedStudent = studentTable.getSelectionModel().getSelectedItem();

        if (selectedStudent == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt sinh vi√™n ƒë·ªÉ x√≥a!");
            return;
        }

        // Hi·ªÉn th·ªã x√°c nh·∫≠n x√≥a
        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n c√≥ MSSV: " + selectedStudent.getStudentID() + " kh√¥ng?");

        if (!confirm)
            return;

        String sql = "DELETE FROM students WHERE student_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, selectedStudent.getStudentID());
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "ƒê√£ x√≥a sinh vi√™n th√†nh c√¥ng!");
                addStudentsShowList(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch sinh vi√™n trong b·∫£ng
            } else {
                AlertComponent.showError("L·ªói", null, "Kh√¥ng th·ªÉ x√≥a sinh vi√™n!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c xo√° to√†n b·ªô sinh vi√™n trong b·∫£ng
    private void handleDeleteAllStudents() {
        // Hi·ªÉn th·ªã c·∫£nh b√°o tr∆∞·ªõc khi x√≥a to√†n b·ªô d·ªØ li·ªáu
        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô sinh vi√™n trong h·ªá th·ªëng kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!");

        if (!confirm)
            return;

        String sql = "DELETE FROM students";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "ƒê√£ x√≥a to√†n b·ªô sinh vi√™n th√†nh c√¥ng!");
                addStudentsShowList(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch sinh vi√™n trong b·∫£ng
            } else {
                AlertComponent.showWarning("Th√¥ng b√°o", null, "Kh√¥ng c√≥ sinh vi√™n n√†o trong h·ªá th·ªëng ƒë·ªÉ x√≥a!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c t√¨m ki·∫øm sinh vi√™n
    private void searchStudent() {
        String keyword = studentManageSearch.getText().toLowerCase().trim();
        if (keyword.isEmpty()) {
            studentTable.setItems(addStudentsListD); // N·∫øu √¥ t√¨m ki·∫øm tr·ªëng, hi·ªÉn th·ªã l·∫°i to√†n b·ªô d·ªØ li·ªáu
            return;
        }

        ObservableList<StudentData> filteredList = FXCollections.observableArrayList();
        for (StudentData student : addStudentsListD) {
            if (student.getStudentID().toLowerCase().contains(keyword) ||
                    student.getFirstName().toLowerCase().contains(keyword) ||
                    student.getLastName().toLowerCase().contains(keyword)) {
                filteredList.add(student);
            }
        }

        studentTable.setItems(filteredList);
    }

    // Show add student form
    private void handleAddBtn() {
        showStage.showWindows("../view/student_form.fxml", "");
    }

    // MORE...

    // ========== QU·∫¢N L√ù SINH VI√äN ==========

    // ========== QU·∫¢N L√ù M√îN H·ªåC ==========

    private void clearFormSubject() {
        txtSubjectID.setDisable(false); // M·ªü kh√≥a √¥ nh·∫≠p m√£ m√¥n h·ªçc
        btnAddSubject.setDisable(false); // M·ªü kh√≥a n√∫t th√™m

        txtSubjectID.clear();
        txtSubjectName.clear();
        txtCredits.clear();
        cbLecturer.setValue("Ch·ªçn");
        cbSemester.setValue("Ch·ªçn");
        cbStatus.setValue("Ch·ªçn");
    }

    // Ph∆∞∆°ng th·ª©c l·∫•y d·ªØ li·ªáu t·ª´ database -> √°nh x·∫° v√†o table view
    public ObservableList<CourseData> getCoursesListData() {
        ObservableList<CourseData> courseList = FXCollections.observableArrayList();
        String sql = "SELECT * FROM courses";

        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            resultSet = preparedStatement.executeQuery();

            while (resultSet.next()) {
                courseList.add(new CourseData(
                        resultSet.getString("course_id"),
                        resultSet.getString("course_name"),
                        resultSet.getInt("credits"),
                        resultSet.getString("lecturer"),
                        resultSet.getString("semester"),
                        resultSet.getString("status")));
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return courseList;
    }

    private ObservableList<CourseData> courseListData;

    public void showCoursesList() {
        courseListData = getCoursesListData();

        colSubjectID.setCellValueFactory(new PropertyValueFactory<>("subjectID"));
        colSubjectName.setCellValueFactory(new PropertyValueFactory<>("subjectName"));
        colCredits.setCellValueFactory(new PropertyValueFactory<>("credits"));
        colLecturer.setCellValueFactory(new PropertyValueFactory<>("lecturer"));
        colSemester.setCellValueFactory(new PropertyValueFactory<>("semester"));
        colStatus.setCellValueFactory(new PropertyValueFactory<>("status"));

        tblSubjects.setItems(courseListData);
    }

    private void loadSelectedCourseData() {
        CourseData selectedCourse = tblSubjects.getSelectionModel().getSelectedItem();

        if (selectedCourse == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc!");
            return;
        }

        // Load d·ªØ li·ªáu v√†o c√°c √¥ nh·∫≠p li·ªáu
        txtSubjectID.setText(selectedCourse.getSubjectID());
        txtSubjectName.setText(selectedCourse.getSubjectName());
        txtCredits.setText(String.valueOf(selectedCourse.getCredits()));
        cbLecturer.setValue(selectedCourse.getLecturer());
        cbSemester.setValue(selectedCourse.getSemester());
        cbStatus.setValue(selectedCourse.getStatus());

        // Kh√≥a √¥ nh·∫≠p m√£ m√¥n h·ªçc ƒë·ªÉ tr√°nh thay ƒë·ªïi
        txtSubjectID.setDisable(true);
    }

    // Ki·ªÉm tra input h·ª£p l·ªá ƒë·ªëi v·ªõi m√¥n h·ªçc
    private boolean validateCourseInput() {
        if (txtSubjectID.getText().trim().isEmpty() ||
                txtSubjectName.getText().trim().isEmpty() ||
                txtCredits.getText().trim().isEmpty() ||
                cbLecturer.getValue().equals("Ch·ªçn") ||
                cbSemester.getValue() == null ||
                cbStatus.getValue() == null ||
                cbSemester.getValue().equals("Ch·ªçn") ||
                cbStatus.getValue().equals("Ch·ªçn")) {

            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return false;
        }

        // Ki·ªÉm tra m√£ m√¥n h·ªçc b·∫Øt ƒë·∫ßu b·∫±ng "MH"
        String courseID = txtSubjectID.getText().trim();
        if (!courseID.matches("^MH\\d+$")) { // M√£ ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "MH" v√† theo sau l√† s·ªë
            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "M√£ m√¥n h·ªçc ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 'MH' v√† theo sau l√† s·ªë!");
            return false;
        }

        // Ki·ªÉm tra s·ªë t√≠n ch·ªâ l√† s·ªë h·ª£p l·ªá
        try {
            int credits = Integer.parseInt(txtCredits.getText().trim());
            if (credits <= 0) {
                AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "S·ªë t√≠n ch·ªâ ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng!");
                return false;
            }
        } catch (NumberFormatException e) {
            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "S·ªë t√≠n ch·ªâ ph·∫£i l√† s·ªë nguy√™n!");
            return false;
        }

        return true;
    }

    // Ki·ªÉm tra m√£ m√¥n h·ªçc ƒë√£ t·ªìn t·∫°i ch∆∞a
    private boolean isCourseIDExists(String courseID) {
        String sql = "SELECT COUNT(*) FROM courses WHERE course_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, courseID);
            resultSet = preparedStatement.executeQuery();
            if (resultSet.next() && resultSet.getInt(1) > 0) {
                return true; // M√£ m√¥n h·ªçc ƒë√£ t·ªìn t·∫°i
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        return false; // M√£ m√¥n h·ªçc ch∆∞a t·ªìn t·∫°i
    }

    private void handleAddCourse() {

        if (!validateCourseInput())
            return; // Ki·ªÉm tra input h·ª£p l·ªá

        String courseID = txtSubjectID.getText().trim();
        String courseName = txtSubjectName.getText().trim();
        int credits = Integer.parseInt(txtCredits.getText().trim());
        String lecturer = cbLecturer.getValue();
        String semester = cbSemester.getValue();
        String status = cbStatus.getValue();

        // Ki·ªÉm tra tr√πng m√£ m√¥n h·ªçc
        if (isCourseIDExists(courseID)) {
            AlertComponent.showWarning("L·ªói", null, "M√£ m√¥n h·ªçc ƒë√£ t·ªìn t·∫°i!");
            return;
        }

        String sql = "INSERT INTO courses (course_id, course_name, credits, lecturer, semester, status) VALUES (?, ?, ?, ?, ?, ?)";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, courseID);
            preparedStatement.setString(2, courseName);
            preparedStatement.setInt(3, credits);
            preparedStatement.setString(4, lecturer);
            preparedStatement.setString(5, semester);
            preparedStatement.setString(6, status);

            int rowsInserted = preparedStatement.executeUpdate();
            if (rowsInserted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "M√¥n h·ªçc ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!");
                showCoursesList(); // C·∫≠p nh·∫≠t danh s√°ch m√¥n h·ªçc

                updateStudentSubjectsComboBox();

                clearFormSubject(); // X√≥a form nh·∫≠p
            } else {
                AlertComponent.showError("L·ªói", null, "Kh√¥ng th·ªÉ th√™m m√¥n h·ªçc!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c xo√° m·ªôt m√¥n h·ªçc kh·ªèi danh s√°ch
    private void handleDeleteCourse() {
        CourseData selectedCourse = tblSubjects.getSelectionModel().getSelectedItem();

        if (selectedCourse == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc ƒë·ªÉ x√≥a!");
        }

        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc: " + selectedCourse.getSubjectName() + "?");

        if (!confirm)
            return;

        // X√≥a trong database
        String sql = "DELETE FROM courses WHERE course_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, selectedCourse.getSubjectID());
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "M√¥n h·ªçc ƒë√£ ƒë∆∞·ª£c x√≥a!");
                showCoursesList();

                updateStudentSubjectsComboBox();
            } else {
                AlertComponent.showError("L·ªói", null, "Kh√¥ng th·ªÉ x√≥a m√¥n h·ªçc!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c xo√° to√†n b·ªô m√¥n h·ªçc
    private void handleDeleteAllCourses() {
        if (tblSubjects.getItems().isEmpty()) {
            AlertComponent.showWarning("Th√¥ng b√°o", null, "Kh√¥ng c√≥ m√¥n h·ªçc n√†o ƒë·ªÉ x√≥a!");
            return;
        }

        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô m√¥n h·ªçc trong h·ªá th·ªëng?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!");

        if (!confirm)
            return;

        String sql = "DELETE FROM courses";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "ƒê√£ x√≥a to√†n b·ªô m√¥n h·ªçc!");
                showCoursesList(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch m√¥n h·ªçc

                updateStudentSubjectsComboBox();
            } else {
                AlertComponent.showWarning("Th√¥ng b√°o", null, "Kh√¥ng c√≥ m√¥n h·ªçc n√†o ƒë·ªÉ x√≥a!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t m√¥n h·ªçc
    private void handleUpdateCourse() {
        // L·∫•y m√¥n h·ªçc ƒë∆∞·ª£c ch·ªçn t·ª´ TableView
        CourseData selectedCourse = tblSubjects.getSelectionModel().getSelectedItem();

        if (selectedCourse == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc ƒë·ªÉ c·∫≠p nh·∫≠t!");
            return;
        }

        // Ki·ªÉm tra n·∫øu c√≥ tr∆∞·ªùng n√†o b·ªã b·ªè tr·ªëng
        if (txtSubjectName.getText().trim().isEmpty() ||
                txtCredits.getText().trim().isEmpty() ||
                cbLecturer.getValue() == null || cbLecturer.getValue().equals("Ch·ªçn") ||
                cbSemester.getValue() == null || cbSemester.getValue().equals("Ch·ªçn") ||
                cbStatus.getValue() == null || cbStatus.getValue().equals("Ch·ªçn")) {

            AlertComponent.showWarning("L·ªói nh·∫≠p d·ªØ li·ªáu", null, "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin m√¥n h·ªçc!");
            return;
        }

        // Ki·ªÉm tra s·ªë t√≠n ch·ªâ ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng
        int credits;
        try {
            credits = Integer.parseInt(txtCredits.getText().trim());
            if (credits <= 0) {
                AlertComponent.showWarning("L·ªói nh·∫≠p d·ªØ li·ªáu", null, "S·ªë t√≠n ch·ªâ ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng!");
                return;
            }
        } catch (NumberFormatException e) {
            AlertComponent.showWarning("L·ªói nh·∫≠p d·ªØ li·ªáu", null, "S·ªë t√≠n ch·ªâ ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng!");
            return;
        }

        // Ki·ªÉm tra t√™n m√¥n h·ªçc c√≥ b·ªã tr√πng kh√¥ng (tr·ª´ m√¥n h·ªçc ƒëang ch·ªânh s·ª≠a)
        String checkQuery = "SELECT COUNT(*) FROM courses WHERE course_name = ? AND course_id != ?";
        connect = database.connectDB();
        try {
            preparedStatement = connect.prepareStatement(checkQuery);
            preparedStatement.setString(1, txtSubjectName.getText().trim());
            preparedStatement.setString(2, selectedCourse.getSubjectID());
            resultSet = preparedStatement.executeQuery();
            resultSet.next();

            if (resultSet.getInt(1) > 0) {
                AlertComponent.showWarning("L·ªói nh·∫≠p d·ªØ li·ªáu", null, "T√™n m√¥n h·ªçc ƒë√£ t·ªìn t·∫°i, vui l√≤ng nh·∫≠p t√™n kh√°c!");
                return;
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu m√¥n h·ªçc
        String updateQuery = "UPDATE courses SET course_name = ?, credits = ?, lecturer = ?, semester = ?, status = ? WHERE course_id = ?";

        try {
            preparedStatement = connect.prepareStatement(updateQuery);
            preparedStatement.setString(1, txtSubjectName.getText().trim());
            preparedStatement.setInt(2, credits);
            preparedStatement.setString(3, cbLecturer.getValue());
            preparedStatement.setString(4, cbSemester.getValue());
            preparedStatement.setString(5, cbStatus.getValue());
            preparedStatement.setString(6, selectedCourse.getSubjectID());

            int rowsUpdated = preparedStatement.executeUpdate();
            if (rowsUpdated > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "M√¥n h·ªçc ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
                showCoursesList(); // L√†m m·ªõi danh s√°ch m√¥n h·ªçc
                clearFormSubject(); // Xo√° form nh·∫≠p li·ªáu
            } else {
                AlertComponent.showError("L·ªói", null, "C·∫≠p nh·∫≠t m√¥n h·ªçc kh√¥ng th√†nh c√¥ng!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c Update ComboBox m√¥n h·ªçc trong Qu·∫£n l√Ω sinh vi√™n
    private void updateStudentSubjectsComboBox() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("../view/student_form.fxml"));
            Parent root = loader.load();

            studentController studentCtrl = loader.getController();
            studentCtrl.loadSubjectsIntoComboBox(); // C·∫≠p nh·∫≠t danh s√°ch m√¥n h·ªçc

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // ========== QU·∫¢N L√ù M√îN H·ªåC ==========

    // ========== QU·∫¢N L√ù GI·∫¢NG VI√äN ==========

    private ObservableList<LecturerData> lecturerListData;

    // L·∫•y danh s√°ch gi·∫£ng vi√™n t·ª´ database
    public ObservableList<LecturerData> getLecturerListData() {
        ObservableList<LecturerData> lecturerList = FXCollections.observableArrayList();
        String sql = "SELECT * FROM lecturers"; // B·∫£ng gi·∫£ng vi√™n

        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            resultSet = preparedStatement.executeQuery();

            while (resultSet.next()) {
                lecturerList.add(new LecturerData(
                        resultSet.getString("lecturer_id"),
                        resultSet.getString("lecturer_name"),
                        resultSet.getString("gender"),
                        resultSet.getString("degree"),
                        resultSet.getString("phone"),
                        resultSet.getString("status")));
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return lecturerList;
    }

    // Hi·ªÉn th·ªã danh s√°ch gi·∫£ng vi√™n l√™n TableView
    public void showLecturersList() {
        lecturerListData = getLecturerListData();

        colLecturerID.setCellValueFactory(new PropertyValueFactory<>("lecturerID"));
        colLecturerName.setCellValueFactory(new PropertyValueFactory<>("lecturerName"));
        colLecturerGender.setCellValueFactory(new PropertyValueFactory<>("gender"));
        colLecturerDegree.setCellValueFactory(new PropertyValueFactory<>("degree"));
        colLecturerPhone.setCellValueFactory(new PropertyValueFactory<>("phone"));
        colLecturerStatus.setCellValueFactory(new PropertyValueFactory<>("status"));

        tableLecturer.setItems(lecturerListData);
    }

    // C·∫≠p nh·∫≠t gi·∫£ng vi√™n v√†o comboBox trong qu·∫£n l√Ω m√¥n h·ªçc
    private void updateLecturersInCourse() {
        ObservableList<String> lecturerList = FXCollections.observableArrayList();
        String sql = "SELECT lecturer_name, degree, status FROM lecturers"; // L·∫•y c·∫£ t√™n, h·ªçc v·ªã v√† tr·∫°ng th√°i

        connect = database.connectDB();
        try {
            preparedStatement = connect.prepareStatement(sql);
            resultSet = preparedStatement.executeQuery();
            while (resultSet.next()) {
                String lecturerName = resultSet.getString("lecturer_name");
                String degree = resultSet.getString("degree");
                String status = resultSet.getString("status"); // L·∫•y tr·∫°ng th√°i c·ªßa gi·∫£ng vi√™n

                // Logic -> N·∫øu gi·∫£ng vi√™n ngh·ªâ ph√©p ho·∫∑c ƒë√£ ngh·ªâ h∆∞u th√¨ kh√¥ng th√™m v√†o
                // ComboBox
                if (status.equalsIgnoreCase("Ngh·ªâ ph√©p") || status.equalsIgnoreCase("ƒê√£ ngh·ªâ h∆∞u")) {
                    continue;
                }

                String formattedName = formatLecturerName(lecturerName, degree);
                lecturerList.add(formattedName);
            }
            cbLecturer.setItems(lecturerList); // C·∫≠p nh·∫≠t ComboBox gi·∫£ng vi√™n trong Qu·∫£n l√Ω M√¥n h·ªçc
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    /**
     * ƒê·ªãnh d·∫°ng t√™n gi·∫£ng vi√™n theo h·ªçc v·ªã
     */
    private String formatLecturerName(String name, String degree) {
        switch (degree) {
            case "C·ª≠ nh√¢n":
                return "CN. " + name;
            case "Th·∫°c sƒ©":
                return "ThS. " + name;
            case "Ti·∫øn sƒ©":
                return "TS. " + name;
            case "Ph√≥ gi√°o s∆∞":
                return "PGS. " + name;
            case "Gi√°o s∆∞":
                return "GS. " + name;
            default:
                return name; // N·∫øu kh√¥ng c√≥ h·ªçc v·ªã, tr·∫£ v·ªÅ nguy√™n t√™n
        }
    }

    // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p v√†o input
    private boolean validateLecturerInput() {
        if (txtLecturerID.getText().trim().isEmpty() ||
                txtLecturerName.getText().trim().isEmpty() ||
                cbLecturerGender.getValue() == null || cbLecturerGender.getValue().equals("Ch·ªçn") ||
                cbLecturerDegree.getValue() == null || cbLecturerDegree.getValue().equals("Ch·ªçn") ||
                txtLecturerPhone.getText().trim().isEmpty() ||
                cbLecturerStatus.getValue() == null || cbLecturerStatus.getValue().equals("Ch·ªçn")) {

            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return false;
        }

        // Ki·ªÉm tra m√£ gi·∫£ng vi√™n ph·∫£i b·∫Øt ƒë·∫ßu -> GV -> S·ªë
        if (!txtLecturerID.getText().trim().matches("^GV\\d+$")) {
            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null,
                    "M√£ gi·∫£ng vi√™n ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 'GV' v√† theo sau l√† s·ªë!");
            return false;
        }

        // Ki·ªÉm tra xem s·ªë ƒëi·ªán tho·∫°i ƒë·ªß 10-11 ch·ªØ s·ªë kh√¥ng
        if (!txtLecturerPhone.getText().trim().matches("^\\d{10,11}$")) {
            AlertComponent.showWarning("L·ªói nh·∫≠p li·ªáu", null, "S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë!");
            return false;
        }

        return true;
    }

    // Ki·ªÉm tra m√£ gi·∫£ng vi√™n ƒë√£ t·ªìn t·∫°i hay ch∆∞a?
    private boolean isLecturerIDExists(String lecturerID) {
        String sql = "SELECT COUNT(*) FROM lecturers WHERE lecturer_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, lecturerID);
            resultSet = preparedStatement.executeQuery();
            if (resultSet.next() && resultSet.getInt(1) > 0) {
                return true;
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        return false;
    }

    // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i ch∆∞a
    // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i trong database (tr·ª´ gi·∫£ng vi√™n hi·ªán t·∫°i)
    private boolean isPhoneNumberExists(String phone, String currentLecturerID) {
        String sql = "SELECT COUNT(*) FROM lecturers WHERE phone = ? AND lecturer_id != ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, phone);
            preparedStatement.setString(2, currentLecturerID);
            resultSet = preparedStatement.executeQuery();
            if (resultSet.next() && resultSet.getInt(1) > 0) {
                return true;
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        return false;
    }

    // Ph∆∞∆°ng th·ª©c th√™m gi·∫£ng vi√™n v√†o database v√† load v√†o tableview
    private void handleAddLecturer() {
        if (!validateLecturerInput())
            return;

        String lecturerID = txtLecturerID.getText().trim();
        String lecturerName = txtLecturerName.getText().trim();
        String gender = cbLecturerGender.getValue();
        String degree = cbLecturerDegree.getValue();
        String phone = txtLecturerPhone.getText().trim();
        String status = cbLecturerStatus.getValue();

        // Ki·ªÉm tra tr√πng M√£ gi·∫£ng vi√™n trong database
        if (isLecturerIDExists(lecturerID)) {
            AlertComponent.showWarning("L·ªói", null, "M√£ gi·∫£ng vi√™n ƒë√£ t·ªìn t·∫°i! Vui l√≤ng nh·∫≠p m√£ kh√°c.");
            return;
        }

        // Ki·ªÉm tra tr√πng S·ªë ƒëi·ªán tho·∫°i trong database
        if (isPhoneNumberExists(phone, lecturerID)) {
            AlertComponent.showWarning("L·ªói", null, "S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i! Vui l√≤ng nh·∫≠p s·ªë kh√°c.");
            return;
        }

        String sql = "INSERT INTO lecturers (lecturer_id, lecturer_name, gender, degree, phone, status) VALUES (?, ?, ?, ?, ?, ?)";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, lecturerID);
            preparedStatement.setString(2, lecturerName);
            preparedStatement.setString(3, gender);
            preparedStatement.setString(4, degree);
            preparedStatement.setString(5, phone);
            preparedStatement.setString(6, status);

            int rowsInserted = preparedStatement.executeUpdate();
            if (rowsInserted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "Gi·∫£ng vi√™n ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!");
                showLecturersList(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n v√†o TableView -> B·∫£ng
                updateLecturersInCourse(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n v√†o ComboBox trong Qu·∫£n l√Ω m√¥n h·ªçc
                handleClearFormLecturer(); // Xo√° form nh·∫≠p li·ªáu khi th√™m th√†nh c√¥ng gi·∫£ng vi√™n
            } else {
                AlertComponent.showError("L·ªói", null, "Kh√¥ng th·ªÉ th√™m gi·∫£ng vi√™n!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Nh·∫•p ƒë√¥i v√†o gi·∫£ng vi√™n -> ch·ªçn gi·∫£ng vi√™n
    private void loadSelectedLecturerData() {
        LecturerData selectedLecturer = tableLecturer.getSelectionModel().getSelectedItem();

        if (selectedLecturer == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt gi·∫£ng vi√™n!");
            return;
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu v√†o c√°c √¥ nh·∫≠p
        txtLecturerID.setText(selectedLecturer.getLecturerID());
        txtLecturerName.setText(selectedLecturer.getLecturerName());
        cbLecturerGender.setValue(selectedLecturer.getGender());
        cbLecturerDegree.setValue(selectedLecturer.getDegree());
        txtLecturerPhone.setText(selectedLecturer.getPhone());
        cbLecturerStatus.setValue(selectedLecturer.getStatus());

        // V√¥ hi·ªáu h√≥a √¥ M√£ gi·∫£ng vi√™n
        txtLecturerID.setDisable(true);
    }

    // Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t gi·∫£ng vi√™n
    private void handleUpdateLecturer() {
        // L·∫•y gi·∫£ng vi√™n ƒë∆∞·ª£c ch·ªçn t·ª´ TableView
        LecturerData selectedLecturer = tableLecturer.getSelectionModel().getSelectedItem();

        if (selectedLecturer == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt gi·∫£ng vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t!");
            return;
        }

        // Ki·ªÉm tra xem c√°c tr∆∞·ªùng nh·∫≠p c√≥ h·ª£p l·ªá kh√¥ng
        if (!validateLecturerInput())
            return;

        String lecturerID = selectedLecturer.getLecturerID(); // Kh√¥ng cho s·ª≠a m√£ gi·∫£ng vi√™n
        String lecturerName = txtLecturerName.getText().trim();
        String gender = cbLecturerGender.getValue();
        String degree = cbLecturerDegree.getValue();
        String phone = txtLecturerPhone.getText().trim();
        String status = cbLecturerStatus.getValue();

        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i c√≥ b·ªã tr√πng kh√¥ng (tr·ª´ gi·∫£ng vi√™n hi·ªán t·∫°i)
        if (isPhoneNumberExists(phone, lecturerID)) {
            AlertComponent.showWarning("L·ªói nh·∫≠p d·ªØ li·ªáu", null,
                    "S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi m·ªôt gi·∫£ng vi√™n kh√°c!");
            return;
        }

        // X√°c nh·∫≠n tr∆∞·ªõc khi c·∫≠p nh·∫≠t
        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n c·∫≠p nh·∫≠t", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t th√¥ng tin gi·∫£ng vi√™n: " + lecturerName + " kh√¥ng?");

        if (!confirm)
            return;

        String sql = "UPDATE lecturers SET lecturer_name = ?, gender = ?, degree = ?, phone = ?, status = ? WHERE lecturer_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, lecturerName);
            preparedStatement.setString(2, gender);
            preparedStatement.setString(3, degree);
            preparedStatement.setString(4, phone);
            preparedStatement.setString(5, status);
            preparedStatement.setString(6, lecturerID);

            int rowsUpdated = preparedStatement.executeUpdate();
            if (rowsUpdated > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "Th√¥ng tin gi·∫£ng vi√™n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
                showLecturersList(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch gi·∫£ng vi√™n
                updateLecturersInCourse(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong Qu·∫£n l√Ω M√¥n h·ªçc
                handleClearFormLecturer(); // Xo√° form nh·∫≠p li·ªáu
            } else {
                AlertComponent.showError("L·ªói", null, "C·∫≠p nh·∫≠t kh√¥ng th√†nh c√¥ng!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void handleDeleteLecturer() {
        // L·∫•y gi·∫£ng vi√™n ƒë∆∞·ª£c ch·ªçn t·ª´ TableView
        LecturerData selectedLecturer = tableLecturer.getSelectionModel().getSelectedItem();

        if (selectedLecturer == null) {
            AlertComponent.showWarning("L·ªói", null, "Vui l√≤ng ch·ªçn m·ªôt gi·∫£ng vi√™n ƒë·ªÉ x√≥a!");
            return;
        }

        // Hi·ªÉn th·ªã x√°c nh·∫≠n tr∆∞·ªõc khi x√≥a
        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a gi·∫£ng vi√™n: " + selectedLecturer.getLecturerName() + " kh√¥ng?");

        if (!confirm)
            return;

        String sql = "DELETE FROM lecturers WHERE lecturer_id = ?";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            preparedStatement.setString(1, selectedLecturer.getLecturerID());
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "Gi·∫£ng vi√™n ƒë√£ ƒë∆∞·ª£c x√≥a!");
                showLecturersList(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong TableView
                updateLecturersInCourse(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong Qu·∫£n l√Ω m√¥n h·ªçc
            } else {
                AlertComponent.showError("L·ªói", null, "Kh√¥ng th·ªÉ x√≥a gi·∫£ng vi√™n!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void handleClearAllLecturer() {
        if (tableLecturer.getItems().isEmpty()) {
            AlertComponent.showWarning("Th√¥ng b√°o", null, "Kh√¥ng c√≥ gi·∫£ng vi√™n n√†o ƒë·ªÉ x√≥a!");
            return;
        }

        // Hi·ªÉn th·ªã c·∫£nh b√°o tr∆∞·ªõc khi x√≥a to√†n b·ªô d·ªØ li·ªáu
        boolean confirm = AlertComponent.showConfirmation("X√°c nh·∫≠n", null,
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô gi·∫£ng vi√™n trong h·ªá th·ªëng?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!");

        if (!confirm)
            return;

        String sql = "DELETE FROM lecturers";
        connect = database.connectDB();

        try {
            preparedStatement = connect.prepareStatement(sql);
            int rowsDeleted = preparedStatement.executeUpdate();

            if (rowsDeleted > 0) {
                AlertComponent.showInformation("Th√†nh c√¥ng", null, "ƒê√£ x√≥a to√†n b·ªô gi·∫£ng vi√™n!");
                showLecturersList(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong TableView
                updateLecturersInCourse(); // C·∫≠p nh·∫≠t danh s√°ch gi·∫£ng vi√™n trong Qu·∫£n l√Ω m√¥n h·ªçc
            } else {
                AlertComponent.showWarning("Th√¥ng b√°o", null, "Kh√¥ng c√≥ gi·∫£ng vi√™n n√†o ƒë·ªÉ x√≥a!");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                if (preparedStatement != null)
                    preparedStatement.close();
                if (connect != null)
                    connect.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void handleClearFormLecturer() {
        // X·ª≠ l√Ω c√°c logic khi xo√° form nh·∫≠p li·ªáu
        txtLecturerID.setDisable(false); // M·ªü kh√≥a √¥ nh·∫≠p m√£ gi·∫£ng vi√™n
        btnAddLecturer.setDisable(false); // M·ªü kh√≥a n√∫t th√™m gi·∫£ng vi√™n

        // Clear all forms
        txtLecturerID.clear();
        txtLecturerName.clear();
        txtLecturerPhone.clear();
        cbLecturerGender.setValue(null);
        cbLecturerDegree.setValue(null);
        cbLecturerStatus.setValue(null);
    }

    // ========== QU·∫¢N L√ù GI·∫¢NG VI√äN ==========

    // ========== QU·∫¢N L√ù ƒêI·ªÇM ==========

    private void setupTableColumns() {
        colStudentIDGrades.setCellValueFactory(new PropertyValueFactory<>("studentID"));
        colSchoolYearGrades.setCellValueFactory(new PropertyValueFactory<>("schoolYear"));
        colSubjectGrades.setCellValueFactory(new PropertyValueFactory<>("subject"));
        colMidtermGrade.setCellValueFactory(new PropertyValueFactory<>("midterm"));
        colFinalGrade.setCellValueFactory(new PropertyValueFactory<>("finalExam"));
        colTotalGrade.setCellValueFactory(new PropertyValueFactory<>("totalGrade"));
    }

    private void loadGradesData() {
        // ObservableList<Grades> gradesList = FXCollections.observableArrayList();

        // // Gi·∫£ l·∫≠p d·ªØ li·ªáu t·ª´ database
        // gradesList.add(new Grades("SV001", "2023-2024", "L·∫≠p tr√¨nh Java", 7.5, 8.0,
        // 7.75));
        // gradesList.add(new Grades("SV002", "2023-2024", "C·∫•u tr√∫c d·ªØ li·ªáu", 6.0, 7.5,
        // 6.75));

        // tableGrades.setItems(gradesList);
    }

    private void handleAddGrades() {
        System.out.println("Add grades");
    }

    private void handleUpdateGrades() {
        System.out.println("Update grades");
    }

    private void handleDeleteGrades() {
        System.out.println("Delete grades");
    }

    private void handleClearAllGrades() {
        System.out.println("Clear all grades");
    }

    private void handleRefreshGrades() {
        System.out.println("Refresh grades");
    }

    private void clearGradesForm() {
        txtStudentIDGrades.clear();
        lblSchoolYearGrades.setText("-");
        lblSubjectGrades.setText("-");
        txtMidtermGrade.clear();
        txtFinalGrade.clear();
        txtTotalGrade.clear();
    }

    // ========== QU·∫¢N L√ù ƒêI·ªÇM ==========

    // ========== TH√îNG TIN ==========

    private void versionBtnHandle() {
        if (teamForm.isVisible() || technologyForm.isVisible() || clauseForm.isVisible() || questionForm.isVisible()) {
            questionForm.setVisible(false);
            teamForm.setVisible(false);
            technologyForm.setVisible(false);
            clauseForm.setVisible(false);
        }
        versionForm.setVisible(true);
    }

    private void teamBtnHandle() {
        if (versionForm.isVisible() || technologyForm.isVisible() || clauseForm.isVisible()
                || questionForm.isVisible()) {
            questionForm.setVisible(false);
            versionForm.setVisible(false);
            technologyForm.setVisible(false);
            clauseForm.setVisible(false);
        }
        teamForm.setVisible(true);
    }

    private void technologyBtnHandle() {
        if (versionForm.isVisible() || teamForm.isVisible() || clauseForm.isVisible() || questionForm.isVisible()) {
            versionForm.setVisible(false);
            teamForm.setVisible(false);
            clauseForm.setVisible(false);
            questionForm.setVisible(false);
        }
        technologyForm.setVisible(true);
    }

    private void clauseBtnHandle() {
        if (versionForm.isVisible() || teamForm.isVisible() || technologyForm.isVisible() || questionForm.isVisible()) {
            versionForm.setVisible(false);
            teamForm.setVisible(false);
            technologyForm.setVisible(false);
            questionForm.setVisible(false);
        }
        clauseForm.setVisible(true);
    }

    private void questionBtnHandle() {
        if (versionForm.isVisible() || teamForm.isVisible() || technologyForm.isVisible() || clauseForm.isVisible()) {
            versionForm.setVisible(false);
            teamForm.setVisible(false);
            technologyForm.setVisible(false);
            clauseForm.setVisible(false);
        }
        questionForm.setVisible(true);
    }

    // ========== TH√îNG TIN ==========

    // ---> END C√ÅC H√ÄM X·ª¨ L√ù <---
}
